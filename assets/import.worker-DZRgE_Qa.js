class c{buffer="";currentRecord=null;currentMetadata=[];isInRecord=!1;totalCount=0;processChunk(e){const t=[],a=(this.buffer+e).split(`
`);this.buffer=a.pop()||"";for(const i of a){const r=i.trim();r&&(r.startsWith("<Record ")?(this.isInRecord=!0,this.currentRecord=this.parseRecordAttributes(r),r.endsWith("/>")&&(this.currentRecord&&(t.push(this.currentRecord),this.totalCount++),this.resetState())):r.startsWith("</Record>")?(this.currentRecord&&(this.currentMetadata.length>0&&(this.currentRecord.metadata=this.currentMetadata),t.push(this.currentRecord),this.totalCount++),this.resetState()):r.startsWith("<MetadataEntry ")&&this.isInRecord&&this.currentMetadata.push(this.parseMetadataAttributes(r)))}return t}parseRecordAttributes(e){const t=this.extractAttributes(e);return{id:this.generateRecordId(t),type:t.type,sourceName:t.sourceName,sourceVersion:t.sourceVersion,device:"device"in t?this.sanitizeHTMLEntities(t.device):void 0,unit:t.unit,value:Number(t.value),creationDate:this.sanitizeDate(t.creationDate),startDate:this.sanitizeDate(t.startDate),endDate:this.sanitizeDate(t.endDate)}}parseMetadataAttributes(e){const t=this.extractAttributes(e);return{key:t.key,value:t.value}}sanitizeHTMLEntities(e){const t={"&lt;":"<","&gt;":">","&amp;":"&","&quot;":'"',"&#39;":"'"};return e.replace(/&lt;|&gt;|&amp;|&quot;|&#39;/g,s=>t?.[s])}extractAttributes(e){const t={},s=e.matchAll(/(\w+)="([^"]+)"/g);for(const a of s)t[a[1]]=a[2];return t}resetState(){this.currentRecord=null,this.currentMetadata=[],this.isInRecord=!1}sanitizeDate(e){return e.replace(/\s{1}(\+\d{2})(\d{2})$/,"$1:$2")}generateRecordId(e){const t=JSON.stringify(e);let s=0;for(let i=0;i<t.length;i++){const r=t.charCodeAt(i);s=(s<<5)-s+r,s=s&s}const a=new Date(this.sanitizeDate(e.creationDate)).getTime();return`${Math.abs(s).toString(16)}-${a.toString(16)}`}}const o=new c,u=new TextDecoder;self.onmessage=async n=>{try{const e=u.decode(n.data.data),t=o.processChunk(e),s=n.data.offset/n.data.size*100;self.postMessage({records:t,progress:s,totalCount:o.totalCount})}catch(e){self.postMessage({type:"error",error:e})}};
