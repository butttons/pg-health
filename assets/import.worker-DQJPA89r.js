class i{buffer="";currentRecord=null;currentMetadata=[];isInRecord=!1;totalCount=0;processChunk(e){const t=[],a=(this.buffer+e).split(`
`);this.buffer=a.pop()||"";for(const o of a){const s=o.trim();s&&(s.startsWith("<Record ")?(this.isInRecord=!0,this.currentRecord=this.parseRecordAttributes(s),s.endsWith("/>")&&(this.currentRecord&&(t.push(this.currentRecord),this.totalCount++),this.resetState())):s.startsWith("</Record>")?(this.currentRecord&&(this.currentMetadata.length>0&&(this.currentRecord.metadata=this.currentMetadata),t.push(this.currentRecord),this.totalCount++),this.resetState()):s.startsWith("<MetadataEntry ")&&this.isInRecord&&this.currentMetadata.push(this.parseMetadataAttributes(s)))}return t}parseRecordAttributes(e){const t=this.extractAttributes(e);return{id:this.generateRecordId(t),type:t.type,sourceName:t.sourceName,sourceVersion:t.sourceVersion,device:"device"in t?decodeURIComponent(t.device):void 0,unit:t.unit,value:Number(t.value),creationDate:t.creationDate,startDate:t.startDate,endDate:t.endDate}}parseMetadataAttributes(e){const t=this.extractAttributes(e);return{key:t.key,value:t.value}}extractAttributes(e){const t={},r=e.matchAll(/(\w+)="([^"]+)"/g);for(const a of r)t[a[1]]=a[2];return t}resetState(){this.currentRecord=null,this.currentMetadata=[],this.isInRecord=!1}generateRecordId(e){const t=JSON.stringify(e);let r=0;for(let o=0;o<t.length;o++){const s=t.charCodeAt(o);r=(r<<5)-r+s,r=r&r}const a=new Date(e.creationDate).getTime();return`${Math.abs(r).toString(16)}-${a.toString(16)}`}}const c=new i,d=new TextDecoder;self.onmessage=async n=>{try{const e=d.decode(n.data.data),t=c.processChunk(e),r=n.data.offset/n.data.size*100;self.postMessage({records:t,progress:r,totalCount:c.totalCount})}catch(e){self.postMessage({type:"error",error:e})}};
